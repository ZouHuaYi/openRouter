# 限流功能增强说明

## 🎯 新功能概览

### 1. 刷新状态按钮
在模型列表页面右上角添加了"刷新状态"按钮，可以手动刷新所有后端的限流状态，解决后端被限流但前端 UI 没有更新的问题。

### 2. 限流设置集成到编辑对话框
限流设置已从独立的下拉菜单移到"编辑后端"对话框中，提供更统一和完整的管理体验。

### 3. 三种限流模式

#### 模式 1：预设模式（北京时间 0 点解封）
**适用场景**：服务商按天/周/月限流
- ✅ 1 天（明天 0 点解封）
- ✅ 1 周（下周同一天 0 点解封）
- ✅ 1 月（下月同一天 0 点解封）

**特点**：
- 所有时间都按北京时间计算
- 解封时间固定在 00:00:00
- 适合按周期重置的限额场景

**示例**：
```
当前时间：2026-02-06 15:30
选择"1 天"：解封时间 = 2026-02-07 00:00（北京时间）
选择"1 周"：解封时间 = 2026-02-13 00:00（北京时间）
选择"1 月"：解封时间 = 2026-03-06 00:00（北京时间）
```

#### 模式 2：按小时（自动延后 3 分钟）
**适用场景**：服务商按小时限流
- ✅ 自定义小时数（1-168 小时，即 1-7 天）
- ✅ 自动延后 3 分钟，避免服务器延迟

**特点**：
- 从当前时刻精确计算
- 自动添加 3 分钟缓冲时间
- 避免因网络/服务器延迟导致过早解封被再次限流

**示例**：
```
当前时间：2026-02-06 15:30:00
设置 1 小时：解封时间 = 2026-02-06 16:33:00（15:30 + 1小时 + 3分钟）
设置 6 小时：解封时间 = 2026-02-06 21:33:00（15:30 + 6小时 + 3分钟）
设置 24 小时：解封时间 = 2026-02-07 15:33:00（15:30 + 24小时 + 3分钟）
```

**为什么要延后 3 分钟？**
- 服务器响应时间：API 可能需要几秒钟处理请求
- 时钟同步误差：客户端和服务器时间可能有几秒差异
- 限流器更新延迟：服务商的限流计数器可能不是实时更新
- 安全边际：宁可晚 3 分钟解封，也不要过早触发二次限流

#### 模式 3：按天数
**适用场景**：固定天数的限制
- ✅ 自定义天数（1-90 天）
- ✅ 从当前时刻精确计算

**特点**：
- 从当前时刻精确计算到秒
- 不按 0 点解封，保持时间精度
- 适合固定期限的封禁场景

**示例**：
```
当前时间：2026-02-06 15:30:45
设置 1 天：解封时间 = 2026-02-07 15:30:45
设置 3 天：解封时间 = 2026-02-09 15:30:45
设置 7 天：解封时间 = 2026-02-13 15:30:45
```

---

## 📖 使用指南

### 添加带限流的后端

1. 点击"添加后端"按钮
2. 选择服务商和模型
3. 在"限流设置"部分：
   - 开启"启用限流"开关
   - 选择限流类型（预设/按小时/按天数）
   - 设置具体参数
4. 点击"确定"保存

### 编辑现有后端的限流设置

1. 点击后端行的"编辑"按钮
2. 在对话框中调整限流设置：
   - 开启/关闭限流
   - 修改限流类型和参数
3. 点击"确定"保存

**注意**：编辑模式下，服务商和模型 ID 不可修改（防止改错配置）

### 快速解封

两种方式：

**方式 1**：表格中的快速操作
- 如果后端处于限流状态，"快速操作"列会显示"立即解封"按钮
- 点击即可解除限流

**方式 2**：编辑对话框中关闭限流
- 打开编辑对话框
- 关闭"启用限流"开关
- 点击"确定"保存

### 刷新状态

当你发现后端被外部限流（通过 API 返回错误得知）时：
1. 点击页面右上角的"刷新状态"按钮
2. UI 会重新读取所有后端的限流状态
3. 显示最新的状态信息

---

## 🔧 技术细节

### 时间计算逻辑

**预设模式（北京时间 0 点）**：
```javascript
// 计算下一个北京时间 0 点
function nextBeijingMidnight(baseMs) {
  const parts = beijingParts(baseMs)
  const midnight = beijingMidnightTs(parts)
  return baseMs >= midnight ? midnight + 24 * 60 * 60 * 1000 : midnight
}

// 1 天 = 下一个 0 点
// 1 周 = 7 天后的 0 点
// 1 月 = 下个月同一天的 0 点
```

**按小时模式（+3 分钟缓冲）**：
```javascript
const hours = parseInt(value) || 1
const ms = now + hours * 60 * 60 * 1000 + 3 * 60 * 1000
return new Date(ms).toISOString()
```

**按天数模式（精确计算）**：
```javascript
const days = parseInt(value) || 1
const ms = now + days * 24 * 60 * 60 * 1000
return new Date(ms).toISOString()
```

### 数据存储

限流状态保存在 `config/backend-state.json`：
```json
{
  "doubao:model-name": {
    "unblockAt": "2026-02-07T16:33:00.000Z"
  }
}
```

**说明**：
- Key：`provider:model` 格式
- Value：`{ unblockAt: ISO时间戳 }`
- 解封时间到达后，后端自动变为可用状态

### UI 状态刷新

状态刷新触发时机：
1. ✅ 页面加载时（`onMounted`）
2. ✅ 保存后端配置后
3. ✅ 删除后端后
4. ✅ 点击"刷新状态"按钮
5. ✅ 快速解封操作后

---

## 🎯 使用场景示例

### 场景 1：服务商每天限流 1000 次请求

**问题**：每天 00:00 重置限额，触发限流后需要等到第二天 00:00

**解决方案**：
- 限流类型：**预设模式**
- 选择：**1 天**
- 效果：自动在北京时间第二天 00:00 解封

### 场景 2：服务商每小时限流 100 次请求

**问题**：触发限流后需要等 1 小时，但服务器可能有延迟

**解决方案**：
- 限流类型：**按小时**
- 设置：**1 小时**
- 效果：1 小时 + 3 分钟后解封（安全边际）

### 场景 3：手动封禁某个模型 3 天

**问题**：发现某个模型质量不好，想临时封禁 3 天

**解决方案**：
- 限流类型：**按天数**
- 设置：**3 天**
- 效果：从当前时刻精确计算 72 小时后解封

### 场景 4：后端被限流了但 UI 没显示

**问题**：API 返回 429 错误，但页面显示"可用"

**解决方案**：
1. 点击"刷新状态"按钮
2. 或者打开编辑对话框手动设置限流

---

## 🔄 升级说明

### 从旧版本升级

旧版本的限流数据完全兼容，无需迁移：
- ✅ 现有的 `backend-state.json` 数据继续有效
- ✅ 旧的限流时间自动被识别
- ✅ 可以直接使用新功能

### 界面变化

| 旧版本 | 新版本 |
|--------|--------|
| 下拉菜单设置限流 | 编辑对话框中设置限流 |
| 只有 3 个预设（天/周/月） | 3 种模式 + 自定义 |
| 无刷新按钮 | 右上角刷新按钮 |
| 表格中下拉菜单解封 | 表格中独立解封按钮 |

---

## ⚠️ 注意事项

### 1. 服务商和模型不可修改
编辑模式下，服务商和模型 ID 字段被禁用，防止误修改导致配置错乱。

如需修改，请：
1. 删除旧后端
2. 添加新后端

### 2. 限流时间立即生效
保存限流设置后，状态立即更新，后端会被标记为"限流"状态，直到解封时间到达。

### 3. 解封时间自动检查
每次刷新页面或点击"刷新状态"，系统会检查所有解封时间：
- 已到期的自动变为"可用"
- 未到期的继续显示"限流"

### 4. 小时模式的 3 分钟缓冲
按小时模式自动添加 3 分钟，**不可取消**。这是为了避免：
- 网络延迟
- 时钟误差
- 服务器响应时间
- 限流计数器更新延迟

如果确实需要精确到分钟，请使用"按天数"模式并设置小数（如 0.042 天 = 1 小时）。

### 5. 时区问题
- 预设模式：严格按**北京时间**（UTC+8）计算
- 小时/天数模式：使用本地时间计算，但存储为 UTC

**建议**：统一使用预设模式（天/周/月），可以避免时区混淆。

---

## 🐛 故障排查

### 问题 1：设置限流后状态没变化

**检查项**：
1. 点击"刷新状态"按钮
2. 检查 `config/backend-state.json` 是否有对应数据
3. 检查浏览器控制台是否有错误（`Ctrl+Shift+I`）

### 问题 2：解封时间不对

**检查项**：
1. 确认选择的模式是否正确
2. 预设模式：检查是否理解"北京时间 0 点"的含义
3. 小时模式：别忘了有 3 分钟延后
4. 天数模式：是从当前时刻开始，不是 0 点

### 问题 3：刷新按钮点击无反应

**可能原因**：
- 页面正在加载中
- 网络请求失败

**解决方法**：
- 等待几秒后重试
- 检查 Electron 应用是否正常运行
- 重启应用

---

## 📈 未来计划

可能的增强功能：
- [ ] 批量设置限流
- [ ] 限流历史记录
- [ ] 自动检测 API 限流并更新状态
- [ ] 限流统计和报表
- [ ] 自定义缓冲时间（目前固定 3 分钟）

---

## 🎉 总结

新的限流功能提供了更灵活、更精确的后端管理能力：

- ✅ **刷新按钮**：手动同步状态，解决 UI 更新问题
- ✅ **集成管理**：限流设置在编辑对话框中，操作更统一
- ✅ **三种模式**：覆盖所有常见限流场景
- ✅ **自动缓冲**：小时模式 +3 分钟，避免过早解封
- ✅ **快速解封**：表格中一键解封，操作更便捷
- ✅ **持久化**：所有设置重启后保持，数据安全可靠

**立即体验**：重启应用后，进入"模型列表"标签页即可使用新功能！
