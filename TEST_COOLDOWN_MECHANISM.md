# 限流机制测试指南

## 🚀 重新启动应用

关闭当前应用，重新构建：

```bash
npm run ui
```

等待构建完成后，应用会自动打开。

---

## ✅ 测试清单

### 测试 1：配置限流规则（不触发）- 2分钟

**目标**：验证配置规则后模型仍然可用

1. 进入"模型列表"标签页
2. 点击第一个后端的"编辑"按钮
3. 在"限流规则配置"部分：
   - 开启"启用限流规则"开关
   - 选择"预设（0点解封）"
   - 选择"1 天（0点解封）"
4. 点击"确定"

**预期结果**：
- ✅ 看到"已更新"提示
- ✅ 表格中"限流规则"列显示"预设：1天"
- ✅ "当前状态"列仍然显示"可用"
- ✅ "快速操作"列显示"触发限流"按钮（可点击）

**验证文件**：
```bash
type config\providers.json
```

应该看到：
```json
{
  "backends": [
    {
      "provider": "doubao",
      "model": "xxx",
      "cooldownRule": {
        "type": "preset",
        "value": "day"
      }
    }
  ]
}
```

---

### 测试 2：触发限流 - 1分钟

**目标**：验证点击"触发限流"按钮后状态变化

1. 找到刚才配置规则的后端
2. 点击"快速操作"列的"触发限流"按钮
3. 观察变化

**预期结果**：
- ✅ 看到"已触发限流"提示
- ✅ "当前状态"列变为"限流至 XX"（明天 00:00）
- ✅ "快速操作"列变为"解封"按钮

**验证文件**：
```bash
type config\backend-state.json
```

应该看到：
```json
{
  "doubao:model-name": {
    "unblockAt": "2026-02-07T00:00:00.000Z"
  }
}
```

---

### 测试 3：解封 - 30秒

**目标**：验证解封功能

1. 找到限流的后端
2. 点击"解封"按钮
3. 观察变化

**预期结果**：
- ✅ 看到"已解封"提示
- ✅ "当前状态"列变为"可用"
- ✅ "快速操作"列变为"触发限流"按钮
- ✅ "限流规则"列仍然显示规则（规则未删除）

**验证文件**：
```bash
type config\backend-state.json
```

对应的 key 应该被删除。

---

### 测试 4：不同规则类型 - 3分钟

**目标**：测试三种规则类型

**4.1 预设模式（1周）**
1. 编辑第二个后端
2. 配置规则：预设 - 1周
3. 保存并触发限流
4. ✅ 解封时间应该是下周同一天的 00:00

**4.2 按小时模式（2小时）**
1. 编辑第三个后端
2. 配置规则：按小时 - 2小时
3. 保存并触发限流
4. ✅ 解封时间应该是当前时间 + 2小时3分钟

**4.3 按天数模式（3天）**
1. 编辑第四个后端
2. 配置规则：按天数 - 3天
3. 保存并触发限流
4. ✅ 解封时间应该是3天后的相同时刻

---

### 测试 5：未配置规则的后端 - 1分钟

**目标**：验证未配置规则时的按钮状态

1. 找到一个未配置规则的后端
2. 观察"快速操作"列

**预期结果**：
- ✅ "限流规则"列显示"未设置"
- ✅ "触发限流"按钮应该是灰色（禁用状态）
- ✅ 点击按钮会提示"该后端未配置限流规则"

---

### 测试 6：编辑已有规则 - 2分钟

**目标**：验证修改规则不影响现有状态

1. 编辑一个已触发限流的后端
2. ✅ "启用限流规则"开关应该是开启的
3. ✅ 显示之前配置的规则
4. 修改规则（如从"1天"改为"1周"）
5. 保存

**预期结果**：
- ✅ 规则已更新（providers.json）
- ✅ 限流状态不变（backend-state.json）
- ✅ "当前状态"仍然显示之前的解封时间

**验证**：
- 解封该后端
- 重新触发限流
- ✅ 新的解封时间应该按新规则计算

---

### 测试 7：删除规则 - 1分钟

**目标**：验证关闭规则

1. 编辑一个有规则的后端
2. 关闭"启用限流规则"开关
3. 保存

**预期结果**：
- ✅ "限流规则"列显示"未设置"
- ✅ "触发限流"按钮变为禁用
- ✅ providers.json 中该后端没有 `cooldownRule` 字段

---

### 测试 8：刷新状态 - 30秒

**目标**：验证刷新功能

1. 点击右上角"刷新状态"按钮
2. ✅ 看到"已刷新"提示
3. ✅ 所有状态保持正确

---

### 测试 9：持久化验证 - 2分钟

**目标**：验证规则和状态重启后保持

1. 配置 2-3 个后端的规则
2. 触发其中 1-2 个的限流
3. 记录所有状态
4. **关闭应用**
5. **重新运行 `npm run ui`**
6. 进入"模型列表"

**预期结果**：
- ✅ 所有规则配置保持
- ✅ 所有限流状态保持
- ✅ 解封时间正确显示

---

## 🎬 完整场景测试

### 场景：模拟真实使用

**背景**：
- 有 5 个后端模型
- 服务商每天限流，00:00 重置

**操作流程**：

1. **初始配置（一次性）**
   - 为所有 5 个后端配置规则：预设 - 1天
   - 保存（所有模型保持可用）

2. **使用过程**
   - 调用 API 使用模型 1
   - API 返回 429 错误（被限流）
   - 点击模型 1 的"触发限流"
   - 模型 1 状态变为"限流至明天00:00"

3. **继续使用**
   - 模型 1 不可用，自动切换到模型 2
   - 模型 2 也被限流了
   - 点击模型 2 的"触发限流"
   - 依次类推...

4. **第二天**
   - 点击"刷新状态"
   - 所有模型自动解封（时间已过00:00）
   - 继续使用

5. **紧急情况**
   - 发现限额提前恢复
   - 手动点击"解封"
   - 立即可用

---

## 📊 状态对照表

### 不同状态下的UI显示

| 配置状态 | 限流状态 | 限流规则列 | 当前状态列 | 快速操作列 |
|----------|----------|------------|------------|------------|
| 未配置规则 | 未限流 | 未设置 | 可用 | 触发限流（禁用） |
| 已配置规则 | 未限流 | 显示规则 | 可用 | 触发限流 |
| 已配置规则 | 已限流 | 显示规则 | 限流至XX | 解封 |
| 未配置规则 | 已限流* | 未设置 | 限流至XX | 解封 |

*注：理论上不应该出现这种状态，但支持手动清除规则保留状态

---

## 🔍 数据验证

### 检查 providers.json

```bash
type config\providers.json
```

**验证点**：
- backends 数组中有规则的后端包含 `cooldownRule` 字段
- `cooldownRule.type` 和 `cooldownRule.value` 正确
- 未配置规则的后端没有 `cooldownRule` 字段

### 检查 backend-state.json

```bash
type config\backend-state.json
```

**验证点**：
- 只有触发限流的后端有数据
- `unblockAt` 是有效的 ISO 时间戳
- 已解封的后端对应的 key 已删除

### 时间计算验证

使用浏览器控制台（`Ctrl+Shift+I`）：

```javascript
// 查看 ISO 时间戳对应的北京时间
new Date('2026-02-07T00:00:00.000Z').toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })
// 输出: 2026/2/7 08:00:00

// 实际应该是北京时间 00:00:00，说明是 UTC+8
// 验证正确：2026-02-07T00:00:00.000Z = 北京时间 2026/2/7 08:00 - 8小时 = 2026/2/7 00:00
```

**注意**：ISO 时间戳存储的是 UTC 时间，显示时需要考虑时区。

---

## 🐛 常见问题

### 问题 1：点击"触发限流"没反应

**检查**：
1. 是否配置了规则？
2. 浏览器控制台是否有错误？
3. 按钮是否是灰色（禁用状态）？

### 问题 2：解封时间不对

**检查**：
1. 确认规则类型和参数
2. 使用浏览器控制台转换时间验证
3. 预设模式要注意是北京时间 00:00

### 问题 3：规则保存后找不到

**检查**：
1. 查看 providers.json 文件
2. 确认是否开启了"启用限流规则"开关
3. 是否点击了"确定"保存

### 问题 4：状态显示不一致

**解决**：
1. 点击"刷新状态"按钮
2. 关闭并重新打开应用
3. 检查文件是否正确保存

---

## ✅ 验收标准

所有以下功能都应该正常工作：

- ✅ 配置规则后模型仍然可用
- ✅ "触发限流"按钮正常工作
- ✅ 限流状态正确显示
- ✅ "解封"按钮正常工作
- ✅ 规则和状态分离存储
- ✅ 修改规则不影响现有状态
- ✅ 删除规则按钮变为禁用
- ✅ 未配置规则时按钮禁用
- ✅ 所有规则类型计算正确
- ✅ 重启后规则和状态都保持

---

## 🎉 测试完成

如果所有测试都通过，恭喜！新的限流机制已经完全可用。

### 核心要点

1. **规则 ≠ 状态**：配置规则不会立即限流
2. **手动触发**：需要点击"触发限流"才生效
3. **规则保留**：解封后规则仍在，可再次触发
4. **灵活控制**：随时修改规则，随时触发/解封

**现在可以按照真实场景使用限流功能了！**
